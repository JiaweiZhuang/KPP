! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
! 
! The Stoichiometric Chemical Model File
! 
! Generated by KPP-2.2.3 symbolic chemistry Kinetics PreProcessor
!       (http://www.cs.vt.edu/~asandu/Software/KPP)
! KPP is distributed under GPL, the general public licence
!       (http://www.gnu.org/copyleft/gpl.html)
! (C) 1995-1997, V. Damian & A. Sandu, CGRER, Univ. Iowa
! (C) 1997-2005, A. Sandu, Michigan Tech, Virginia Tech
!     With important contributions from:
!        M. Damian, Villanova University, USA
!        R. Sander, Max-Planck Institute for Chemistry, Mainz, Germany
! 
! File                 : strato_Stoichiom.f90
! Time                 : Tue Feb 27 15:54:08 2018
! Working directory    : /home/zhuangjw/KPP/my_tests/strato/strato_code
! Equation file        : strato.kpp
! Output root filename : strato
! 
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~



MODULE strato_Stoichiom

  USE strato_Parameters
  USE strato_StoichiomSP

  IMPLICIT NONE

CONTAINS


! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
! 
! ReactantProd - Reactant Products in each equation
!   Arguments :
!      V         - Concentrations of variable species (local)
!      F         - Concentrations of fixed species (local)
!      ARP       - Reactant product in each equation
! 
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

SUBROUTINE ReactantProd ( V, F, ARP )

! V - Concentrations of variable species (local)
  REAL(kind=dp) :: V(NVAR)
! F - Concentrations of fixed species (local)
  REAL(kind=dp) :: F(NFIX)
! ARP - Reactant product in each equation
  REAL(kind=dp) :: ARP(NREACT)


! Reactant Products in each equation are useful in the
!     stoichiometric formulation of mass action law
  ARP(1) = V(32)*F(3)
  ARP(2) = V(29)*V(32)
  ARP(3) = V(11)*F(4)
  ARP(4) = V(11)*F(3)
  ARP(5) = V(11)*V(29)
  ARP(6) = V(11)*F(1)
  ARP(7) = V(11)*F(2)
  ARP(8) = V(11)*F(5)
  ARP(9) = V(11)*F(5)
  ARP(10) = V(20)*F(3)
  ARP(11) = V(20)*V(29)
  ARP(12) = V(26)*F(2)
  ARP(13) = V(26)*V(29)
  ARP(14) = V(26)*V(32)
  ARP(15) = V(26)*V(26)
  ARP(16) = V(32)*V(33)
  ARP(17) = V(29)*V(33)
  ARP(18) = V(20)*V(33)
  ARP(19) = V(26)*V(33)
  ARP(20) = V(33)*V(33)
  ARP(21) = V(33)*V(33)*F(1)
  ARP(22) = V(17)*V(26)
  ARP(23) = V(29)*V(30)
  ARP(24) = V(30)*V(33)
  ARP(25) = V(32)*V(34)
  ARP(26) = V(29)*V(34)
  ARP(27) = V(26)*V(34)
  ARP(28) = V(33)*V(34)
  ARP(29) = V(23)*V(32)
  ARP(30) = V(23)*V(30)
  ARP(31) = V(23)*V(34)
  ARP(32) = V(12)
  ARP(33) = V(19)*V(26)
  ARP(34) = V(15)*V(26)
  ARP(35) = V(15)
  ARP(36) = V(12)
  ARP(37) = V(27)*F(3)
  ARP(38) = V(27)*V(29)
  ARP(39) = V(27)*F(2)
  ARP(40) = V(27)*V(33)
  ARP(41) = V(27)*V(33)
  ARP(42) = V(17)*V(27)
  ARP(43) = V(28)*V(32)
  ARP(44) = V(26)*V(28)
  ARP(45) = V(26)*V(28)
  ARP(46) = V(28)*V(33)
  ARP(47) = V(28)*V(30)
  ARP(48) = V(28)*V(34)
  ARP(49) = V(28)*V(28)
  ARP(50) = V(28)*V(28)
  ARP(51) = V(28)*V(28)
  ARP(52) = V(28)*V(28)
  ARP(53) = V(4)
  ARP(54) = V(3)
  ARP(55) = V(16)*V(26)
  ARP(56) = V(18)*V(26)
  ARP(57) = V(22)*V(32)
  ARP(58) = V(22)*V(26)
  ARP(59) = V(22)*V(27)
  ARP(60) = V(22)
  ARP(61) = V(25)*V(29)
  ARP(62) = V(25)*V(33)
  ARP(63) = V(24)*V(25)
  ARP(64) = V(31)*V(32)
  ARP(65) = V(31)*V(33)
  ARP(66) = V(30)*V(31)
  ARP(67) = V(31)*V(34)
  ARP(68) = V(28)*V(31)
  ARP(69) = V(28)*V(31)
  ARP(70) = V(28)*V(31)
  ARP(71) = V(31)*V(31)
  ARP(72) = V(13)*V(26)
  ARP(73) = V(26)*F(6)
  ARP(74) = V(26)*F(5)
  ARP(75) = V(24)*V(26)
  ARP(76) = V(24)*V(32)
  ARP(77) = V(27)*F(5)
  ARP(78) = V(24)*V(27)
  ARP(79) = V(9)*F(3)
  ARP(80) = V(1)*F(3)
  ARP(81) = V(10)*F(3)
  ARP(82) = V(21)*V(30)
  ARP(83) = V(21)*V(33)
  ARP(84) = V(14)*V(26)
  ARP(85) = F(3)
  ARP(86) = V(29)
  ARP(87) = V(29)
  ARP(88) = V(33)
  ARP(89) = V(17)
  ARP(90) = V(34)
  ARP(91) = V(23)
  ARP(92) = V(23)
  ARP(93) = V(12)
  ARP(94) = V(19)
  ARP(95) = V(15)
  ARP(96) = V(15)
  ARP(97) = V(2)
  ARP(98) = V(5)
  ARP(99) = V(3)
  ARP(100) = V(18)
  ARP(101) = V(22)
  ARP(102) = V(22)
  ARP(103) = V(6)
  ARP(104) = V(31)
  ARP(105) = V(7)
  ARP(106) = V(8)
  ARP(107) = V(24)
  ARP(108) = V(24)
  ARP(109) = V(14)
      
END SUBROUTINE ReactantProd

! End of ReactantProd function
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
! 
! JacReactantProd - Jacobian of Reactant Products vector
!   Arguments :
!      V         - Concentrations of variable species (local)
!      F         - Concentrations of fixed species (local)
!      JVRP      - d ARP(1:NREACT)/d VAR (1:NVAR)
! 
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

SUBROUTINE JacReactantProd ( V, F, JVRP )

! V - Concentrations of variable species (local)
  REAL(kind=dp) :: V(NVAR)
! F - Concentrations of fixed species (local)
  REAL(kind=dp) :: F(NFIX)
! JVRP - d ARP(1:NREACT)/d VAR (1:NVAR)
  REAL(kind=dp) :: JVRP(NJVRP)


! Reactant Products in each equation are useful in the
!    stoichiometric formulation of mass action law
! Below we compute the Jacobian of the Reactant Products vector
!    w.r.t. variable species: d ARP(1:NREACT) / d Var(1:NVAR)

! JVRP(1) = dARP(1)/dV(32)
  JVRP(1) = F(3)
! JVRP(2) = dARP(2)/dV(29)
  JVRP(2) = V(32)
! JVRP(3) = dARP(2)/dV(32)
  JVRP(3) = V(29)
! JVRP(4) = dARP(3)/dV(11)
  JVRP(4) = F(4)
! JVRP(5) = dARP(4)/dV(11)
  JVRP(5) = F(3)
! JVRP(6) = dARP(5)/dV(11)
  JVRP(6) = V(29)
! JVRP(7) = dARP(5)/dV(29)
  JVRP(7) = V(11)
! JVRP(8) = dARP(6)/dV(11)
  JVRP(8) = F(1)
! JVRP(9) = dARP(7)/dV(11)
  JVRP(9) = F(2)
! JVRP(10) = dARP(8)/dV(11)
  JVRP(10) = F(5)
! JVRP(11) = dARP(9)/dV(11)
  JVRP(11) = F(5)
! JVRP(12) = dARP(10)/dV(20)
  JVRP(12) = F(3)
! JVRP(13) = dARP(11)/dV(20)
  JVRP(13) = V(29)
! JVRP(14) = dARP(11)/dV(29)
  JVRP(14) = V(20)
! JVRP(15) = dARP(12)/dV(26)
  JVRP(15) = F(2)
! JVRP(16) = dARP(13)/dV(26)
  JVRP(16) = V(29)
! JVRP(17) = dARP(13)/dV(29)
  JVRP(17) = V(26)
! JVRP(18) = dARP(14)/dV(26)
  JVRP(18) = V(32)
! JVRP(19) = dARP(14)/dV(32)
  JVRP(19) = V(26)
! JVRP(20) = dARP(15)/dV(26)
  JVRP(20) = 2*V(26)
! JVRP(21) = dARP(16)/dV(32)
  JVRP(21) = V(33)
! JVRP(22) = dARP(16)/dV(33)
  JVRP(22) = V(32)
! JVRP(23) = dARP(17)/dV(29)
  JVRP(23) = V(33)
! JVRP(24) = dARP(17)/dV(33)
  JVRP(24) = V(29)
! JVRP(25) = dARP(18)/dV(20)
  JVRP(25) = V(33)
! JVRP(26) = dARP(18)/dV(33)
  JVRP(26) = V(20)
! JVRP(27) = dARP(19)/dV(26)
  JVRP(27) = V(33)
! JVRP(28) = dARP(19)/dV(33)
  JVRP(28) = V(26)
! JVRP(29) = dARP(20)/dV(33)
  JVRP(29) = 2*V(33)
! JVRP(30) = dARP(21)/dV(33)
  JVRP(30) = 2*V(33)*F(1)
! JVRP(31) = dARP(22)/dV(17)
  JVRP(31) = V(26)
! JVRP(32) = dARP(22)/dV(26)
  JVRP(32) = V(17)
! JVRP(33) = dARP(23)/dV(29)
  JVRP(33) = V(30)
! JVRP(34) = dARP(23)/dV(30)
  JVRP(34) = V(29)
! JVRP(35) = dARP(24)/dV(30)
  JVRP(35) = V(33)
! JVRP(36) = dARP(24)/dV(33)
  JVRP(36) = V(30)
! JVRP(37) = dARP(25)/dV(32)
  JVRP(37) = V(34)
! JVRP(38) = dARP(25)/dV(34)
  JVRP(38) = V(32)
! JVRP(39) = dARP(26)/dV(29)
  JVRP(39) = V(34)
! JVRP(40) = dARP(26)/dV(34)
  JVRP(40) = V(29)
! JVRP(41) = dARP(27)/dV(26)
  JVRP(41) = V(34)
! JVRP(42) = dARP(27)/dV(34)
  JVRP(42) = V(26)
! JVRP(43) = dARP(28)/dV(33)
  JVRP(43) = V(34)
! JVRP(44) = dARP(28)/dV(34)
  JVRP(44) = V(33)
! JVRP(45) = dARP(29)/dV(23)
  JVRP(45) = V(32)
! JVRP(46) = dARP(29)/dV(32)
  JVRP(46) = V(23)
! JVRP(47) = dARP(30)/dV(23)
  JVRP(47) = V(30)
! JVRP(48) = dARP(30)/dV(30)
  JVRP(48) = V(23)
! JVRP(49) = dARP(31)/dV(23)
  JVRP(49) = V(34)
! JVRP(50) = dARP(31)/dV(34)
  JVRP(50) = V(23)
! JVRP(51) = dARP(32)/dV(12)
  JVRP(51) = 1
! JVRP(52) = dARP(33)/dV(19)
  JVRP(52) = V(26)
! JVRP(53) = dARP(33)/dV(26)
  JVRP(53) = V(19)
! JVRP(54) = dARP(34)/dV(15)
  JVRP(54) = V(26)
! JVRP(55) = dARP(34)/dV(26)
  JVRP(55) = V(15)
! JVRP(56) = dARP(35)/dV(15)
  JVRP(56) = 1
! JVRP(57) = dARP(36)/dV(12)
  JVRP(57) = 1
! JVRP(58) = dARP(37)/dV(27)
  JVRP(58) = F(3)
! JVRP(59) = dARP(38)/dV(27)
  JVRP(59) = V(29)
! JVRP(60) = dARP(38)/dV(29)
  JVRP(60) = V(27)
! JVRP(61) = dARP(39)/dV(27)
  JVRP(61) = F(2)
! JVRP(62) = dARP(40)/dV(27)
  JVRP(62) = V(33)
! JVRP(63) = dARP(40)/dV(33)
  JVRP(63) = V(27)
! JVRP(64) = dARP(41)/dV(27)
  JVRP(64) = V(33)
! JVRP(65) = dARP(41)/dV(33)
  JVRP(65) = V(27)
! JVRP(66) = dARP(42)/dV(17)
  JVRP(66) = V(27)
! JVRP(67) = dARP(42)/dV(27)
  JVRP(67) = V(17)
! JVRP(68) = dARP(43)/dV(28)
  JVRP(68) = V(32)
! JVRP(69) = dARP(43)/dV(32)
  JVRP(69) = V(28)
! JVRP(70) = dARP(44)/dV(26)
  JVRP(70) = V(28)
! JVRP(71) = dARP(44)/dV(28)
  JVRP(71) = V(26)
! JVRP(72) = dARP(45)/dV(26)
  JVRP(72) = V(28)
! JVRP(73) = dARP(45)/dV(28)
  JVRP(73) = V(26)
! JVRP(74) = dARP(46)/dV(28)
  JVRP(74) = V(33)
! JVRP(75) = dARP(46)/dV(33)
  JVRP(75) = V(28)
! JVRP(76) = dARP(47)/dV(28)
  JVRP(76) = V(30)
! JVRP(77) = dARP(47)/dV(30)
  JVRP(77) = V(28)
! JVRP(78) = dARP(48)/dV(28)
  JVRP(78) = V(34)
! JVRP(79) = dARP(48)/dV(34)
  JVRP(79) = V(28)
! JVRP(80) = dARP(49)/dV(28)
  JVRP(80) = 2*V(28)
! JVRP(81) = dARP(50)/dV(28)
  JVRP(81) = 2*V(28)
! JVRP(82) = dARP(51)/dV(28)
  JVRP(82) = 2*V(28)
! JVRP(83) = dARP(52)/dV(28)
  JVRP(83) = 2*V(28)
! JVRP(84) = dARP(53)/dV(4)
  JVRP(84) = 1
! JVRP(85) = dARP(54)/dV(3)
  JVRP(85) = 1
! JVRP(86) = dARP(55)/dV(16)
  JVRP(86) = V(26)
! JVRP(87) = dARP(55)/dV(26)
  JVRP(87) = V(16)
! JVRP(88) = dARP(56)/dV(18)
  JVRP(88) = V(26)
! JVRP(89) = dARP(56)/dV(26)
  JVRP(89) = V(18)
! JVRP(90) = dARP(57)/dV(22)
  JVRP(90) = V(32)
! JVRP(91) = dARP(57)/dV(32)
  JVRP(91) = V(22)
! JVRP(92) = dARP(58)/dV(22)
  JVRP(92) = V(26)
! JVRP(93) = dARP(58)/dV(26)
  JVRP(93) = V(22)
! JVRP(94) = dARP(59)/dV(22)
  JVRP(94) = V(27)
! JVRP(95) = dARP(59)/dV(27)
  JVRP(95) = V(22)
! JVRP(96) = dARP(60)/dV(22)
  JVRP(96) = 1
! JVRP(97) = dARP(61)/dV(25)
  JVRP(97) = V(29)
! JVRP(98) = dARP(61)/dV(29)
  JVRP(98) = V(25)
! JVRP(99) = dARP(62)/dV(25)
  JVRP(99) = V(33)
! JVRP(100) = dARP(62)/dV(33)
  JVRP(100) = V(25)
! JVRP(101) = dARP(63)/dV(24)
  JVRP(101) = V(25)
! JVRP(102) = dARP(63)/dV(25)
  JVRP(102) = V(24)
! JVRP(103) = dARP(64)/dV(31)
  JVRP(103) = V(32)
! JVRP(104) = dARP(64)/dV(32)
  JVRP(104) = V(31)
! JVRP(105) = dARP(65)/dV(31)
  JVRP(105) = V(33)
! JVRP(106) = dARP(65)/dV(33)
  JVRP(106) = V(31)
! JVRP(107) = dARP(66)/dV(30)
  JVRP(107) = V(31)
! JVRP(108) = dARP(66)/dV(31)
  JVRP(108) = V(30)
! JVRP(109) = dARP(67)/dV(31)
  JVRP(109) = V(34)
! JVRP(110) = dARP(67)/dV(34)
  JVRP(110) = V(31)
! JVRP(111) = dARP(68)/dV(28)
  JVRP(111) = V(31)
! JVRP(112) = dARP(68)/dV(31)
  JVRP(112) = V(28)
! JVRP(113) = dARP(69)/dV(28)
  JVRP(113) = V(31)
! JVRP(114) = dARP(69)/dV(31)
  JVRP(114) = V(28)
! JVRP(115) = dARP(70)/dV(28)
  JVRP(115) = V(31)
! JVRP(116) = dARP(70)/dV(31)
  JVRP(116) = V(28)
! JVRP(117) = dARP(71)/dV(31)
  JVRP(117) = 2*V(31)
! JVRP(118) = dARP(72)/dV(13)
  JVRP(118) = V(26)
! JVRP(119) = dARP(72)/dV(26)
  JVRP(119) = V(13)
! JVRP(120) = dARP(73)/dV(26)
  JVRP(120) = F(6)
! JVRP(121) = dARP(74)/dV(26)
  JVRP(121) = F(5)
! JVRP(122) = dARP(75)/dV(24)
  JVRP(122) = V(26)
! JVRP(123) = dARP(75)/dV(26)
  JVRP(123) = V(24)
! JVRP(124) = dARP(76)/dV(24)
  JVRP(124) = V(32)
! JVRP(125) = dARP(76)/dV(32)
  JVRP(125) = V(24)
! JVRP(126) = dARP(77)/dV(27)
  JVRP(126) = F(5)
! JVRP(127) = dARP(78)/dV(24)
  JVRP(127) = V(27)
! JVRP(128) = dARP(78)/dV(27)
  JVRP(128) = V(24)
! JVRP(129) = dARP(79)/dV(9)
  JVRP(129) = F(3)
! JVRP(130) = dARP(80)/dV(1)
  JVRP(130) = F(3)
! JVRP(131) = dARP(81)/dV(10)
  JVRP(131) = F(3)
! JVRP(132) = dARP(82)/dV(21)
  JVRP(132) = V(30)
! JVRP(133) = dARP(82)/dV(30)
  JVRP(133) = V(21)
! JVRP(134) = dARP(83)/dV(21)
  JVRP(134) = V(33)
! JVRP(135) = dARP(83)/dV(33)
  JVRP(135) = V(21)
! JVRP(136) = dARP(84)/dV(14)
  JVRP(136) = V(26)
! JVRP(137) = dARP(84)/dV(26)
  JVRP(137) = V(14)
! JVRP(138) = dARP(86)/dV(29)
  JVRP(138) = 1
! JVRP(139) = dARP(87)/dV(29)
  JVRP(139) = 1
! JVRP(140) = dARP(88)/dV(33)
  JVRP(140) = 1
! JVRP(141) = dARP(89)/dV(17)
  JVRP(141) = 1
! JVRP(142) = dARP(90)/dV(34)
  JVRP(142) = 1
! JVRP(143) = dARP(91)/dV(23)
  JVRP(143) = 1
! JVRP(144) = dARP(92)/dV(23)
  JVRP(144) = 1
! JVRP(145) = dARP(93)/dV(12)
  JVRP(145) = 1
! JVRP(146) = dARP(94)/dV(19)
  JVRP(146) = 1
! JVRP(147) = dARP(95)/dV(15)
  JVRP(147) = 1
! JVRP(148) = dARP(96)/dV(15)
  JVRP(148) = 1
! JVRP(149) = dARP(97)/dV(2)
  JVRP(149) = 1
! JVRP(150) = dARP(98)/dV(5)
  JVRP(150) = 1
! JVRP(151) = dARP(99)/dV(3)
  JVRP(151) = 1
! JVRP(152) = dARP(100)/dV(18)
  JVRP(152) = 1
! JVRP(153) = dARP(101)/dV(22)
  JVRP(153) = 1
! JVRP(154) = dARP(102)/dV(22)
  JVRP(154) = 1
! JVRP(155) = dARP(103)/dV(6)
  JVRP(155) = 1
! JVRP(156) = dARP(104)/dV(31)
  JVRP(156) = 1
! JVRP(157) = dARP(105)/dV(7)
  JVRP(157) = 1
! JVRP(158) = dARP(106)/dV(8)
  JVRP(158) = 1
! JVRP(159) = dARP(107)/dV(24)
  JVRP(159) = 1
! JVRP(160) = dARP(108)/dV(24)
  JVRP(160) = 1
! JVRP(161) = dARP(109)/dV(14)
  JVRP(161) = 1
      
END SUBROUTINE JacReactantProd

! End of JacReactantProd function
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~



! Begin Derivative w.r.t. Rate Coefficients

! ------------------------------------------------------------------------------
! Subroutine for the derivative of Fun with respect to rate coefficients
! -----------------------------------------------------------------------------

      SUBROUTINE  dFun_dRcoeff( V, F, NCOEFF, JCOEFF, DFDR )
       
      USE strato_Parameters
      USE strato_StoichiomSP
      IMPLICIT NONE 

! V - Concentrations of variable/radical/fixed species            
      REAL(kind=dp) V(NVAR), F(NFIX)
! NCOEFF - the number of rate coefficients with respect to which we differentiate
      INTEGER NCOEFF       
! JCOEFF - a vector of integers containing the indices of reactions (rate
!          coefficients) with respect to which we differentiate
      INTEGER JCOEFF(NCOEFF)       
! DFDR  - a matrix containg derivative values; specifically, 
!         column j contains d Fun(1:NVAR) / d RCT( JCOEFF(j) )
!         for each 1 <= j <= NCOEFF
!         This matrix is stored in a column-wise linearized format
      REAL(kind=dp) DFDR(NVAR*NCOEFF)

! Local vector with reactant products
      REAL(kind=dp) A_RPROD(NREACT)
      REAL(kind=dp) aj
      INTEGER i,j,k
      
! Compute the reactant products of all reactions     
      CALL ReactantProd ( V, F, A_RPROD )

! Compute the derivatives by multiplying column JCOEFF(j) of the stoichiometric matrix with A_RPROD       
      DO j=1,NCOEFF
!                  Initialize the j-th column of derivative matrix to zero       
         DO i=1,NVAR
           DFDR(i+NVAR*(j-1)) = 0.0_dp 
         END DO
!                  Column JCOEFF(j) in the stoichiometric matrix times the
!                  reactant product  of the JCOEFF(j)-th reaction      
!                  give the j-th column of the derivative matrix   
         aj = A_RPROD(JCOEFF(j))
         DO k=CCOL_STOICM(JCOEFF(j)),CCOL_STOICM(JCOEFF(j)+1)-1
           DFDR(IROW_STOICM(k)+NVAR*(j-1)) = STOICM(k)*aj
         END DO
      END DO
      
      END SUBROUTINE  dFun_dRcoeff

! End Derivative w.r.t. Rate Coefficients


! Begin Jacobian Derivative w.r.t. Rate Coefficients

! ------------------------------------------------------------------------------
! Subroutine for the derivative of Jac with respect to rate coefficients
! Times a user vector
! -----------------------------------------------------------------------------

      SUBROUTINE  dJac_dRcoeff( V, F, U, NCOEFF, JCOEFF, DJDR )
       
      USE strato_Parameters
      USE strato_StoichiomSP
      IMPLICIT NONE 

! V - Concentrations of variable/fixed species            
      REAL(kind=dp) V(NVAR), F(NFIX)
! U - User-supplied Vector           
      REAL(kind=dp) U(NVAR)
! NCOEFF - the number of rate coefficients with respect to which we differentiate
      INTEGER NCOEFF       
! JCOEFF - a vector of integers containing the indices of reactions (rate
!          coefficients) with respect to which we differentiate
      INTEGER JCOEFF(NCOEFF)       
! DFDR  - a matrix containg derivative values; specifically, 
!         column j contains d Jac(1:NVAR) / d RCT( JCOEFF(j) ) * U
!                     for each 1 <= j <= NCOEFF
!         This matrix is stored in a column-wise linearized format
      REAL(kind=dp) DJDR(NVAR*NCOEFF)

! Local vector for Jacobian of reactant products
      REAL(kind=dp) JV_RPROD(NJVRP)
      REAL(kind=dp) aj
      INTEGER i,j,k
      
! Compute the Jacobian of all reactant products   
      CALL JacReactantProd( V, F, JV_RPROD )

! Compute the derivatives by multiplying column JCOEFF(j) of the stoichiometric matrix with A_PROD       
      DO j=1,NCOEFF
!                  Initialize the j-th column of derivative matrix to zero       
         DO i=1,NVAR
           DJDR(i+NVAR*(j-1)) = 0.0_dp
         END DO
!                  Column JCOEFF(j) in the stoichiometric matrix times the
!                  ( Gradient of reactant product of the JCOEFF(j)-th reaction X user vector )    
!                  give the j-th column of the derivative matrix   
!
!          Row JCOEFF(j) of JV_RPROD times the user vector
         aj = 0.0_dp
         DO k=CROW_JVRP(JCOEFF(j)),CROW_JVRP(JCOEFF(j)+1)-1
             aj = aj + JV_RPROD(k)*U(ICOL_JVRP(k))
         END DO
!          Column JCOEFF(j) of Stoichiom. matrix times aj         
         DO k=CCOL_STOICM(JCOEFF(j)),CCOL_STOICM(JCOEFF(j)+1)-1
           DJDR(IROW_STOICM(k)+NVAR*(j-1)) = STOICM(k)*aj
         END DO
      END DO
      
      END SUBROUTINE  dJac_dRcoeff

! End Jacobian Derivative w.r.t. Rate Coefficients


END MODULE strato_Stoichiom

